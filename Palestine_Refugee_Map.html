<!DOCTYPE html>
<html lang="en">
    <head>
        <title>
            Palestinian Refugee Flow Map
        </title>
        <meta charset="utf-8" />

        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

        <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    
        <script src="https://unpkg.com/leaflet-polylinedecorator/dist/leaflet.polylineDecorator.js"></script>
        
        <style>
            #map { height: 100vh }
            #controls {
                position: absolute;
                top: 120px;
                left: 30px;
                z-index: 1000;
                background: whitesmoke;
                padding: 10px;
                border-radius: 5px;
                box-shadow: 0 0 10px rgba(36, 35, 35, 0.3);
            }
            #yearSlider { width: 200px;}
        </style>
    </head>
    <body>
        <div id="controls">
            <label for="yearSlider">Year: <span id="yearLabel">Pre-1948</span></label><br>
            <input type="range" id="yearSlider" min="0" max="3" step="0.01" value="0">
        </div>
        <div id = "map"></div>
        <script>
            const map = L.map('map').setView([35, 35], 4);
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);
            const flowData = {
                "type": "FeatureCollection",
                "features": [
                {
                    "type": "Feature",
                    "properties": {
                        "origin": "Palestine",
                        "destination": "West Bank",
                        "flows": {
                            "Pre-1948": 440000,
                            "1948": 276000,
                            "1967": 28000,
                            "2025": 3300000
                        }
                    },
                    "geometry": {
                        "type": "LineString", "coordinates": [[34.8516, 31.0461], [35.2330, 31.9000]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "origin": "Palestine",
                        "destination": "Jordan",
                        "flows": {
                            "Pre-1948": 10000,
                            "1948": 350000,
                            "1967": 15000,
                            "2025": 2700000
                        }
                    },
                    "geometry": {
                        "type": "LineString", "coordinates": [[34.8516, 31.0461], [35.9, 31.95]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "origin": "Palestine",
                        "destination": "Israel",
                        "flows": {
                            "Pre-1948": 1200000,
                            "1948": 750000,
                            "1967": 200000,
                            "2025": 2100000
                        }
                    },
                    "geometry": {
                        "type": "LineString", "coordinates": [[34.8516, 31.0461], [34.7818, 32.0853]]
                    }                    
                },
                {
                    "type": "Feature",
                    "properties": {
                        "origin": "Palestine",
                        "destination": "Gaza Strip",
                        "flows": {
                            "Pre-1948": 80000,
                            "1948": 190000,
                            "1967": 10000,
                            "2025": 2100000
                        }
                    },
                    "geometry": {
                        "type": "LineString", "coordinates": [[34.8516, 31.0461], [34.47, 31.5]]
                    }                    
                },
                {
                    "type": "Feature",
                    "properties": {
                        "origin": "Palestine",
                        "destination": "Lebanon",
                        "flows": {
                            "Pre-1948": 5000,
                            "1948": 100000,
                            "1967": 5000,
                            "2025": 450000
                        }
                    },
                    "geometry": {
                        "type": "LineString", "coordinates": [[34.8516, 31.0461], [35.8623, 33.8547]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "origin": "Palestine",
                        "destination": "Syria",
                        "flows": {
                            "Pre-1948": 5000,
                            "1948": 56000,
                            "1967": 10000,
                            "2025": 430000
                        }
                    },
                    "geometry": {
                        "type": "LineString", "coordinates": [[34.8516, 31.0461], [36.5, 33.5]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "origin": "Palestine",
                        "destination": "Egypt",
                        "flows": {
                            "Pre-1948": 5000,
                            "1948": 10000,
                            "1967": 500,
                            "2025": 70000
                        }
                    },
                    "geometry": {
                        "type": "LineString", "coordinates": [[34.8516, 31.0461], [30.0, 26.0]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "origin": "Palestine",
                        "destination": "Saudi Arabia",
                        "flows": {
                            "Pre-1948": 1000,
                            "1948": 2000,
                            "1967": 0,
                            "2025": 327000
                        }
                    },
                    "geometry": {
                        "type": "LineString", "coordinates": [[34.8516, 31.0461], [45.0, 25.0]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "origin": "Palestine",
                        "destination": "United Arab Emirates",
                        "flows": {
                            "Pre-1948": 0,
                            "1948": 1000,
                            "1967": 0,
                            "2025": 200000
                        }
                    },
                    "geometry": {
                        "type": "LineString", "coordinates": [[34.8516, 31.0461], [54.0, 24.0]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "origin": "Palestine",
                        "destination": "Qatar",
                        "flows": {
                            "Pre-1948": 0,
                            "1948": 1000,
                            "1967": 0,
                            "2025": 100000
                        }
                    },
                    "geometry": {
                        "type": "LineString", "coordinates": [[34.8516, 31.0461], [51.5, 25.3]]
                    }                    
                },
                {
                    "type": "Feature",
                    "properties": {
                        "origin": "Palestine",
                        "destination": "Kuwait",
                        "flows": {
                            "Pre-1948": 0,
                            "1948": 2000,
                            "1967": 0,
                            "2025": 40000
                        }
                    },
                    "geometry": {
                        "type": "LineString", "coordinates": [[34.8516, 31.0461], [47.5, 29.3]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "origin": "Palestine",
                        "destination": "Bahrain",
                        "flows": {
                            "Pre-1948": 0,
                            "1948": 500,
                            "1967": 0,
                            "2025": 1000
                        }
                    },
                    "geometry": {
                        "type": "LineString", "coordinates": [[34.8516, 31.0461], [50.55, 26.0]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "origin": "Palestine",
                        "destination": "Oman",
                        "flows": {
                            "Pre-1948": 0,
                            "1948": 500,
                            "1967": 0,
                            "2025": 1000
                        }
                        },
                    "geometry": {
                        "type": "LineString", "coordinates": [[34.8516, 31.0461], [57.5, 21.0]]
                    }                    
                }]
            }

            let flowsLayer;
            let markerLayer;
            const yearMap = ["Pre-1948", "1948", "1967", "2025"]

            function lineWeight(count) {
                const minWeight = 1;
                const maxWeight = 5;

                const minLog = Math.log(500 + 1);
                const maxLog = Math.log(3300000 + 1);
                const logCount = Math.log(count + 1);

                return 2 * (minWeight + (maxWeight - minWeight) * (logCount - minLog) / (maxLog - minLog));
            }

            function populationRadius(count) {
                const minRadius = 2500;
                const maxRadius = 50000;
                const minCount= 500;
                const maxCount= 3300000;

                const safeCount = Math.max(count, minCount); 
                const scaled = Math.sqrt(safeCount - minCount + 1) / Math.sqrt(maxCount - minCount + 1);
                return minRadius + scaled * (maxRadius - minRadius);
            }

            function interpolateSliderVal(sliderValue, flows) {
                const idx = Math.floor(sliderValue);
                const nextIdx = Math.min(idx + 1, yearMap.length - 1);
                const t = sliderValue - idx;

                const startYear = yearMap[idx];
                const endYear = yearMap[nextIdx];

                const startVal = flows[startYear] || 0;
                const endVal = flows[endYear] || 0;

                return startVal + t * (endVal - startVal);
            }

            function interpolateColor(count, maxCount, color) {
                const ratio = Math.min(count / maxCount, 1);
                const r = Math.round(245 + (parseInt(color.slice(1,3),16)-245)*ratio);
                const g = Math.round(245 + (parseInt(color.slice(3,5),16)-245)*ratio);
                const b = Math.round(245 + (parseInt(color.slice(5,7),16)-245)*ratio);
                return `rgb(${r},${g},${b})`;    
            }

            function updateFlows(sliderValue) {
                const yearLabel = yearMap[Math.round(sliderValue)];
                if(flowsLayer) {
                    map.removeLayer(flowsLayer);
                }
                if(markerLayer) {
                    map.removeLayer(markerLayer);
                }

                let maxCountCurrent = 0;
                flowData.features.forEach(f => {
                    const val = f.properties.flows[yearLabel] || 0;
                    if(val > maxCountCurrent) {
                        maxCountCurrent = val;
                    }
                });

                flowsLayer = L.geoJSON(flowData, {
                    style: f => {
                        const interpolatedCount = interpolateSliderVal(sliderValue, f.properties.flows);

                        const destinationMax = f.properties.flows[yearLabel] || 0;
                        const interpolatedColor = destinationMax === 0 ? '#F5F5F5' : interpolateColor(interpolatedCount, destinationMax, "#EE2A35");                        
                        return {
                            color: interpolatedColor,
                            weight: lineWeight(interpolatedCount),
                            opacity: 0.7 
                        }
                    },
                }).addTo(map);

                console.log("Flow data sample:", flowData.features[0]);

                markerLayer = L.layerGroup();
                flowData.features.forEach(f => {                    
                    if (!f.geometry || !f.geometry.coordinates || f.geometry.coordinates.length === 0) {
                        console.warn("Skipping feature with no coordinates:", f);
                        return;
                    }                    
                    const coords = f.geometry.coordinates[f.geometry.coordinates.length - 1];
                    const latlng = [coords[1], coords[0]];

                    const interpolatedCount = interpolateSliderVal(sliderValue, f.properties.flows);
                    const destinationMax = f.properties.flows[yearLabel] || 0;
                    const interpolatedColor = destinationMax === 0 ? '#F5F5F5' : interpolateColor(interpolatedCount, destinationMax, "#009736");                        

                    console.log(interpolatedCount);

                    const marker = L.circle(latlng, {
                        radius: populationRadius(interpolatedCount),
                        fillColor: interpolatedColor,
                        color: interpolatedColor,
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    });
                    
                    const actualCount = f.properties.flows[yearLabel] || 0;
                    const popText = `${f.properties.destination}<br>Year: ${yearLabel}<br>Population: ${actualCount.toLocaleString()}`;
                    marker.bindPopup(popText);
                    marker.bindTooltip(`${f.properties.destination} (${yearLabel})`, { direction: 'top', offset: [0, -10] });
                    marker.addTo(markerLayer);
                });
                markerLayer.addTo(map);
                }

                const yearSlider = document.getElementById('yearSlider');
                const yearLabelEl = document.getElementById('yearLabel');
                yearSlider.addEventListener('input', () => {
                    const sliderValue = parseFloat(yearSlider.value);
                    const yearLabel = yearMap[Math.round(sliderValue)];
                    yearLabelEl.textContent = yearLabel;
                    updateFlows(sliderValue);
                });
            updateFlows(parseFloat(yearSlider.value))
        </script>
    </body>
</html>