<!DOCTYPE html>
<html lang="en">
    <head>
        <title>
            Palestinian Refugee Flow Map
        </title>
        <meta charset="utf-8" />

        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

        <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    
        <script src="https://unpkg.com/leaflet-polylinedecorator/dist/leaflet.polylineDecorator.js"></script>
        
        <style>
            #map { height: 100vh }
            #controls {
                position: absolute;
                top: 120px;
                left: 30px;
                z-index: 1000;
                background: whitesmoke;
                padding: 10px;
                border-radius: 5px;
                box-shadow: 0 0 10px rgba(36, 35, 35, 0.3);
            }
            #controls button {
                margin: 2px;
            }
        </style>
    </head>
    <body>
        <div id="controls">
            <button onclick="updateFlows('Pre-1948')">Pre-1948</button>
            <button onclick="updateFlows('1948')">1948 War</button>
            <button onclick="updateFlows('1967')">1967 War</button>
            <button onclick="updateFlows('2025')">2025</button>
        </div>
        <div id = "map"></div>
        <script>
            const map = L.map('map').setView([35, 35], 4);
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);
            const flowData = {
                "type": "FeatureCollection",
                "features": [
                {
                    "type": "Feature",
                    "properties": {
                        "origin": "Palestine",
                        "destination": "West Bank",
                        "flows": {
                            "Pre-1948": 440000,
                            "1948": 276000,
                            "1967": 28000,
                            "2025": 3300000
                        }
                    },
                    "geometry": {
                        "type": "LineString", "coordinates": [[34.8516, 31.0461], [35.2330, 31.9000]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "origin": "Palestine",
                        "destination": "Jordan",
                        "flows": {
                            "Pre-1948": 10000,
                            "1948": 350000,
                            "1967": 15000,
                            "2025": 2700000
                        }
                    },
                    "geometry": {
                        "type": "LineString", "coordinates": [[34.8516, 31.0461], [35.9, 31.95]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "origin": "Palestine",
                        "destination": "Israel",
                        "flows": {
                            "Pre-1948": 1200000,
                            "1948": 750000,
                            "1967": 200000,
                            "2025": 2100000
                        }
                    },
                    "geometry": {
                        "type": "LineString", "coordinates": [[34.8516, 31.0461], [34.7818, 32.0853]]
                    }                    
                },
                {
                    "type": "Feature",
                    "properties": {
                        "origin": "Palestine",
                        "destination": "Gaza Strip",
                        "flows": {
                            "Pre-1948": 80000,
                            "1948": 190000,
                            "1967": 10000,
                            "2025": 2100000
                        }
                    },
                    "geometry": {
                        "type": "LineString", "coordinates": [[34.8516, 31.0461], [34.47, 31.5]]
                    }                    
                },
                {
                    "type": "Feature",
                    "properties": {
                        "origin": "Palestine",
                        "destination": "Lebanon",
                        "flows": {
                            "Pre-1948": 5000,
                            "1948": 100000,
                            "1967": 5000,
                            "2025": 450000
                        }
                    },
                    "geometry": {
                        "type": "LineString", "coordinates": [[34.8516, 31.0461], [35.8623, 33.8547]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "origin": "Palestine",
                        "destination": "Syria",
                        "flows": {
                            "Pre-1948": 5000,
                            "1948": 56000,
                            "1967": 10000,
                            "2025": 430000
                        }
                    },
                    "geometry": {
                        "type": "LineString", "coordinates": [[34.8516, 31.0461], [36.5, 33.5]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "origin": "Palestine",
                        "destination": "Egypt",
                        "flows": {
                            "Pre-1948": 5000,
                            "1948": 10000,
                            "1967": 500,
                            "2025": 70000
                        }
                    },
                    "geometry": {
                        "type": "LineString", "coordinates": [[34.8516, 31.0461], [30.0, 26.0]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "origin": "Palestine",
                        "destination": "Saudi Arabia",
                        "flows": {
                            "Pre-1948": 1000,
                            "1948": 2000,
                            "1967": 0,
                            "2025": 327000
                        }
                    },
                    "geometry": {
                        "type": "LineString", "coordinates": [[34.8516, 31.0461], [45.0, 25.0]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "origin": "Palestine",
                        "destination": "United Arab Emirates",
                        "flows": {
                            "Pre-1948": 0,
                            "1948": 1000,
                            "1967": 0,
                            "2025": 200000
                        }
                    },
                    "geometry": {
                        "type": "LineString", "coordinates": [[34.8516, 31.0461], [54.0, 24.0]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "origin": "Palestine",
                        "destination": "Qatar",
                        "flows": {
                            "Pre-1948": 0,
                            "1948": 1000,
                            "1967": 0,
                            "2025": 100000
                        }
                    },
                    "geometry": {
                        "type": "LineString", "coordinates": [[34.8516, 31.0461], [51.5, 25.3]]
                    }                    
                },
                {
                    "type": "Feature",
                    "properties": {
                        "origin": "Palestine",
                        "destination": "Kuwait",
                        "flows": {
                            "Pre-1948": 0,
                            "1948": 2000,
                            "1967": 0,
                            "2025": 40000
                        }
                    },
                    "geometry": {
                        "type": "LineString", "coordinates": [[34.8516, 31.0461], [47.5, 29.3]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "origin": "Palestine",
                        "destination": "Bahrain",
                        "flows": {
                            "Pre-1948": 0,
                            "1948": 500,
                            "1967": 0,
                            "2025": 1000
                        }
                    },
                    "geometry": {
                        "type": "LineString", "coordinates": [[34.8516, 31.0461], [50.55, 26.0]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "origin": "Palestine",
                        "destination": "Oman",
                        "flows": {
                            "Pre-1948": 0,
                            "1948": 500,
                            "1967": 0,
                            "2025": 1000
                        }
                        },
                    "geometry": {
                        "type": "LineString", "coordinates": [[34.8516, 31.0461], [57.5, 21.0]]
                    }                    
                }]
            }

            function lineWeight(count) {
                const minWeight = 1;
                const maxWeight = 5;

                const minLog = Math.log(500 + 1);
                const maxLog = Math.log(3300000 + 1);
                const logCount = Math.log(count + 1);

                return 2 * (minWeight + (maxWeight - minWeight) * (logCount - minLog) / (maxLog - minLog));
            }

            function populationRadius(count) {
                if(count == 0) {
                    return 0;
                }
                const minRadius = 10000;
                const maxRadius = 30000;
                const minCount= 500;
                const maxCount= 3300000;

                const safeCount = Math.max(count, minCount); 
                const scaled = Math.sqrt(safeCount - minCount + 1) / Math.sqrt(maxCount - minCount + 1);
                return minRadius + scaled * (maxRadius - minRadius);
            }

            let flowsLayer;
            let arrowsLayer;
            let markerLayer;
            let currentYear = "Pre-1948";

            function updateFlows(year) {
                currentYear = year;
                console.log(currentYear)
                if(flowsLayer) {
                    map.removeLayer(flowsLayer)
                }
                if(arrowsLayer) {
                    map.removeLayer(arrowsLayer)
                }
                if(markerLayer) {
                    map.removeLayer(markerLayer)
                }
                console.log("check")
                flowsLayer = L.geoJSON(flowData, {
                    filter: f => f.properties.flows[year] > 0,
                    style: f => ({
                        color: '#EE2A35',
                        weight: lineWeight(f.properties.flows[year]),
                        opacity: 0.7
                    }),
                }).addTo(map);

                console.log("Flow data sample:", flowData.features[0]);


                markerLayer = L.layerGroup();
                flowData.features.forEach(f => {                    
                    if (!f.geometry || !f.geometry.coordinates || f.geometry.coordinates.length === 0) {
                        console.warn("Skipping feature with no coordinates:", f);
                        return;
                    }                    
                    const coords = f.geometry.coordinates[f.geometry.coordinates.length - 1];
                    const latlng = [coords[1], coords[0]];

                    const count = f.properties.flows[currentYear];
                    if(count == 0) {
                        return;
                    }
                    console.log('Population count for marker:', f.properties.destination, count);


                    const marker = L.circle(latlng, {
                        radius: populationRadius(count),
                        fillColor: '#009736',
                        color: '#006400',
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    });
                    console.log(marker.radius)
                    const popText = `${f.properties.destination}<br>Year: ${currentYear}<br>Population: ${f.properties.flows[currentYear].toLocaleString()}`;
                    marker.bindPopup(popText);

                    marker.bindTooltip(`${f.properties.destination} (${currentYear})`, {
                        direction: 'top',
                        offset: [0, -10]
                    });

                    marker.addTo(markerLayer).bringToFront();
                });
                markerLayer.addTo(map);
                }
            updateFlows('Pre-1948')
        </script>
    </body>
</html>