<!DOCTYPE html>
<html lang="en">
<head>
    <title>Palestinian Refugee Flow Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet + extras -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-polylinedecorator/dist/leaflet.polylineDecorator.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

    <!-- Your external stylesheet (added) -->
    <link rel="stylesheet" href="styles.css">

    <style>
        
        body { margin: 0; padding: 0; font-family: sans-serif; background-color: #111; color: #f0f0f0; }
        #map { height: 100vh; width: 100%; }
        #controls {
            position: fixed;
            top: 180px;
            left: 30px;
            z-index: 3000;
            background: #f5f5f5;
            color: black;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(36, 35, 35, 0.3);
        }
        #yearSlider { width: 200px; }
    </style>
</head>

<body class="map-page">

    <!-- Navigation Bar -->
    <nav class="navbar">
        <h1 class="logo"><a href="index.html">Flow Map</a></h1>
        <ul class="nav-links">
            <li><a href="index.html">Home</a></li>
            <li><a href="Palestine_Refugee_Map.html" class="active">Flow Map</a></li>
            <li><a href="sources.html">Sources</a></li>
            <li><a href="background.html">Background</a></li>
        </ul>
    </nav>

    <div id="controls">
        <label for="yearSlider">Year: <span id="yearLabel">Pre-1948</span></label><br>
        <input type="range" id="yearSlider" min="0" max="3" step="0.01" value="0">
    </div>

    <div id="map"></div>

    <script>
        // Navbar animation (fade out when mouse not near top)
        const navbar = document.querySelector('.navbar');
        
        document.addEventListener('mousemove', e => {
            const nearTop = e.clientY < 100 || navbar.matches(':hover');
            if (nearTop) {
                navbar.style.opacity = '1';
                navbar.style.transform = 'translateY(0)';
            } else {
                navbar.style.opacity = '0';
                navbar.style.transform = 'translateY(-10px)';
            }
        });

        const map = L.map('map', { zoomControl: false }).setView([35, 35], 4);

        // Base map
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap & CARTO',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);
        L.control.zoom({ position: 'bottomleft' }).addTo(map);

        Papa.parse('countries.csv', {
            download: true,
            header: true,
            complete: function(results) {
                const highlightCountries = {};
                results.data.forEach(row => {
                    if (row.country && row.color) {
                        highlightCountries[row.country.trim()] = row.color.trim();
                    }
                });
                addCountryLayer(highlightCountries);
            }
        });

        function addCountryLayer(highlightCountries) {
            fetch('https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json')
                .then(res => res.json())
                .then(data => {
                    L.geoJSON(data, {
                        style: feature => {
                            const name = feature.properties.name;
                            const color = highlightCountries[name] || 'transparent';
                            return {
                                color: '#444',
                                weight: 1,
                                fillColor: color,
                                fillOpacity: color === 'transparent' ? 0 : 0.6
                            };
                        }
                    }).addTo(map);
                })
                .catch(err => console.error('Error loading world geojson:', err));
        }

        // flowData 
        const flowData = {
            "type": "FeatureCollection",
            "features": [
                {
                    "type": "Feature",
                    "properties": {
                        "origin": "Palestine",
                        "destination": "West Bank",
                        "flows": { "Pre-1948": 440000, "1948": 276000, "1967": 28000, "2025": 3300000 }
                    },
                    "geometry": { "type": "LineString", "coordinates": [[34.8516,31.0461],[35.2330,31.9000]] }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "origin": "Palestine",
                        "destination": "Jordan",
                        "flows": { "Pre-1948": 10000, "1948": 350000, "1967": 15000, "2025": 2700000 }
                    },
                    "geometry": { "type": "LineString", "coordinates": [[34.8516,31.0461],[35.9,31.95]] }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "origin": "Palestine",
                        "destination": "Israel",
                        "flows": { "Pre-1948": 1200000, "1948": 750000, "1967": 200000, "2025": 2100000 }
                    },
                    "geometry": { "type": "LineString", "coordinates": [[34.8516,31.0461],[34.7818,32.0853]] }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "origin": "Palestine",
                        "destination": "Gaza Strip",
                        "flows": { "Pre-1948": 80000, "1948": 190000, "1967": 10000, "2025": 2100000 }
                    },
                    "geometry": { "type": "LineString", "coordinates": [[34.8516,31.0461],[34.47,31.5]] }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "origin": "Palestine",
                        "destination": "Lebanon",
                        "flows": { "Pre-1948": 5000, "1948": 100000, "1967": 5000, "2025": 450000 }
                    },
                    "geometry": { "type": "LineString", "coordinates": [[34.8516,31.0461],[35.8623,33.8547]] }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "origin": "Palestine",
                        "destination": "Syria",
                        "flows": { "Pre-1948": 5000, "1948": 56000, "1967": 10000, "2025": 430000 }
                    },
                    "geometry": { "type": "LineString", "coordinates": [[34.8516,31.0461],[36.5,33.5]] }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "origin": "Palestine",
                        "destination": "Egypt",
                        "flows": { "Pre-1948": 5000, "1948": 10000, "1967": 500, "2025": 70000 }
                    },
                    "geometry": { "type": "LineString", "coordinates": [[34.8516,31.0461],[30.0,26.0]] }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "origin": "Palestine",
                        "destination": "Saudi Arabia",
                        "flows": { "Pre-1948": 1000, "1948": 2000, "1967": 0, "2025": 327000 }
                    },
                    "geometry": { "type": "LineString", "coordinates": [[34.8516,31.0461],[45.0,25.0]] }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "origin": "Palestine",
                        "destination": "United Arab Emirates",
                        "flows": { "Pre-1948": 0, "1948": 1000, "1967": 0, "2025": 200000 }
                    },
                    "geometry": { "type": "LineString", "coordinates": [[34.8516,31.0461],[54.0,24.0]] }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "origin": "Palestine",
                        "destination": "Qatar",
                        "flows": { "Pre-1948": 0, "1948": 1000, "1967": 0, "2025": 100000 }
                    },
                    "geometry": { "type": "LineString", "coordinates": [[34.8516,31.0461],[51.5,25.3]] }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "origin": "Palestine",
                        "destination": "Kuwait",
                        "flows": { "Pre-1948": 0, "1948": 2000, "1967": 0, "2025": 40000 }
                    },
                    "geometry": { "type": "LineString", "coordinates": [[34.8516,31.0461],[47.5,29.3]] }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "origin": "Palestine",
                        "destination": "Bahrain",
                        "flows": { "Pre-1948": 0, "1948": 500, "1967": 0, "2025": 1000 }
                    },
                    "geometry": { "type": "LineString", "coordinates": [[34.8516,31.0461],[50.55,26.0]] }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "origin": "Palestine",
                        "destination": "Oman",
                        "flows": { "Pre-1948": 0, "1948": 500, "1967": 0, "2025": 1000 }
                    },
                    "geometry": { "type": "LineString", "coordinates": [[34.8516,31.0461],[57.5,21.0]] }
                }
            ]
        };

        function smoothstep(x) { return x * x * (3 - 2 * x); }

        function lineWeight(count) {
            const minWeight = 1, maxWeight = 5;
            const minLog = Math.log(500 + 1);
            const maxLog = Math.log(3300000 + 1);
            const logCount = Math.log(count + 1);
            return 2 * (minWeight + (maxWeight - minWeight) * (logCount - minLog) / (maxLog - minLog));
        }

        function populationRadius(count) {
            const minRadius = 2500, maxRadius = 50000;
            const minCount = 500, maxCount = 3300000;
            const safeCount = Math.max(count, minCount);
            const scaled = Math.sqrt(safeCount - minCount + 1) / Math.sqrt(maxCount - minCount + 1);
            return minRadius + scaled * (maxRadius - minRadius);
        }

        const yearMap = ["Pre-1948", "1948", "1967", "2025"];

        function interpolateSliderVal(sliderValue, flows) {
            const idx = Math.floor(sliderValue);
            const nextIdx = Math.min(idx + 1, yearMap.length - 1);
            const t = smoothstep(sliderValue - idx);
            const startYear = yearMap[idx];
            const endYear = yearMap[nextIdx];
            const startVal = flows[startYear] || 0;
            const endVal = flows[endYear] || 0;
            return startVal + t * (endVal - startVal);
        }

        function interpolateColor(count, maxCount, color) {
            const ratio = smoothstep(Math.min(count / maxCount, 1));
            const r = Math.round(245 + (parseInt(color.slice(1,3),16)-245)*ratio);
            const g = Math.round(245 + (parseInt(color.slice(3,5),16)-245)*ratio);
            const b = Math.round(245 + (parseInt(color.slice(5,7),16)-245)*ratio);
            return `rgb(${r},${g},${b})`;
        }

        let flowsLayer, markerLayer;

        let decorators = [];

        function updateFlows(sliderValue) {
            const yearLabel = yearMap[Math.round(sliderValue)];
            if (flowsLayer) map.removeLayer(flowsLayer);
            if (markerLayer) map.removeLayer(markerLayer);

            decorators = [];

            flowsLayer = L.layerGroup();
            
            // Draw flow lines
            flowData.features.forEach(f => {
                const interpolatedCount = interpolateSliderVal(sliderValue, f.properties.flows);
                const destinationMax = f.properties.flows[yearLabel] || 0;
                const hasFlow = destinationMax > 0;

                const interpolatedColor = destinationMax === 0 ? '#F5F5F5' : interpolateColor(interpolatedCount, destinationMax, "#EE2A35");

                
                const polyline = L.polyline(
                    f.geometry.coordinates.map(c => [c[1], c[0]]),
                    { color: interpolatedColor, weight: lineWeight(interpolatedCount), opacity: 0.8 }
                ).addTo(flowsLayer);

                if (yearLabel === "Pre-1948" || yearLabel === "2025") {
                    polyline.setStyle({ dashArray: '10,10', opacity: 0.8 });
                    return;
                }

                if (!hasFlow) {
                    polyline.setStyle({ dashArray: null, opacity: 0.8 });
                    return;
                } 


                const decorator = L.polylineDecorator(polyline, {
                    patterns: [
                        {
                            offset: 0,
                            repeat: 50,
                            symbol: L.Symbol.arrowHead({
                                pixelSize: 8,
                                polygon: true,
                                pathOptions: { fillOpacity: 0.9, color: interpolatedColor }
                            })
                        }
                    ]
                }).addTo(flowsLayer);

                decorators.push(decorator);
            });

            flowsLayer.addTo(map);

            markerLayer = L.layerGroup();

            // Draw destination markers
            flowData.features.forEach(f => {
                if (!f.geometry?.coordinates?.length) return;
                const coords = f.geometry.coordinates.at(-1);
                const latlng = [coords[1], coords[0]];
                const interpolatedCount = interpolateSliderVal(sliderValue, f.properties.flows);
                const destinationMax = f.properties.flows[yearLabel] || 0;
                const interpolatedColor = destinationMax === 0 ? '#F5F5F5' : interpolateColor(interpolatedCount, destinationMax, "#009736");
                const marker = L.circle(latlng, {
                    radius: populationRadius(interpolatedCount),
                    fillColor: interpolatedColor,
                    color: interpolatedColor,
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                });
                const actualCount = f.properties.flows[yearLabel] || 0;
                const popText = `${f.properties.destination}<br>Year: ${yearLabel}<br>Population: ${actualCount.toLocaleString()}`;
                marker.bindPopup(popText);
                marker.bindTooltip(`${f.properties.destination} (${yearLabel})`, { direction: 'top', offset: [0, -10] });
                marker.addTo(markerLayer);
            });
            markerLayer.addTo(map);
        
        }

        let animationOffset = 0;

        // Animate arrows
        function animateArrows() {
            animationOffset = (animationOffset + 1) % 50;
            
            if (decorators && decorators.length > 0) {
                 decorators.forEach(decorator => {
                    const patterns = decorator.options.patterns.map(p => ({
                        ...p,
                        offset: animationOffset
                    }));
                    decorator.setPatterns(patterns);
                });
            }
           
            requestAnimationFrame(animateArrows);
        }

        const yearSlider = document.getElementById('yearSlider');
        const yearLabelEl = document.getElementById('yearLabel');
        yearSlider.addEventListener('input', () => {
            const sliderValue = parseFloat(yearSlider.value);
            const yearLabel = yearMap[Math.round(sliderValue)];
            yearLabelEl.textContent = yearLabel;
            updateFlows(sliderValue);
        });

        updateFlows(parseFloat(yearSlider.value));
        animateArrows();
        
    </script>
</body>
</html>
